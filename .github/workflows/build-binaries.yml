name: Build Binaries and Deploy

on:
    push:
        branches:
            - daniel/infisical-binary
        tags:
            - "infisical-standalone/v*.*.*"

defaults:
    run:
        working-directory: ./backend

jobs:
    build-and-deploy:
        runs-on: ubuntu-20.04
        strategy:
            matrix:
                arch: [x64]
                os: [linux]
                include:
                    - os: linux
                      target: node18-linux

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Extract version from tag
              id: extract_version
              run: |
                  if [[ $GITHUB_REF == refs/tags/* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/infisical-standalone/v}
                  else
                    VERSION=$(git rev-parse --short HEAD)
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20

            - name: Install pkg
              run: npm install -g @yao-pkg/pkg

            - name: Install dependencies (backend)
              run: npm install

            - name: Install dependencies (frontend)
              run: npm install --prefix ../frontend

            - name: Prerequisites for pkg
              run: npm run binary:build

            - name: Package into node binary
              run: pkg --no-bytecode --public-packages "*" --public --target ${{ matrix.target }}-${{ matrix.arch }} --output ./binary/infisical-${{ matrix.os }}-${{ matrix.arch }} .

            - name: Build .deb package
              if: matrix.os == 'linux'
              uses: ./.github/workflows/build-deb.yml
              with:
                  os: ${{ matrix.os }}
                  arch: ${{ matrix.arch }}
                  version: ${{ steps.extract_version.outputs.version }}
                  executable_path: ./binary/infisical-${{ matrix.os }}-${{ matrix.arch }}

            - name: Upload to Cloudsmith
              if: matrix.os == 'linux'
              uses: cloudsmith-io/action@v0.5.0
              with:
                  api-key: ${{ secrets.CLOUDSMITH_API_KEY }}
                  command: "push"
                  format: "deb"
                  owner: "your-cloudsmith-org"
                  repo: "your-cloudsmith-repo"
                  distro: "any-distro"
                  release: "any-release"
                  republish: "true"
                  file: ${{ steps.build-deb.outputs.deb_path }}
