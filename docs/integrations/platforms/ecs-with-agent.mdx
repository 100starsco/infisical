---
title: 'Amazon ECS'
description: "How to deliver secrets to Amazon Elastic Container Service"
---

![ecs diagram](/images/guides/agent-with-ecs/ecs-diagram.png)

This guide will go over the steps needed to configure an Amazon Elastic Container Service (ECS) task definition to access secrets stored in Infisical. 

At a high level, the steps involve setting up an ECS task with a [Infisical Agent](/) sidecar container. This sidecar container uses Universal Auth to communicate with Infisical to fetch secrets/access tokens.
Once the secrets/access tokens are retrieved, they are then stored in a shared Amazon Elastic File System (EFS) volume. This volume is then made accessible to your application and all of its replicas.

This guide primarily focuses on integrating Infisical Cloud with Amazon ECS on AWS Fargate and Amazon EFS.
However, the principles and steps can be adapted for use with any instance of Infisical (on premise or cloud) and different ECS configurations.

## Prerequisites
This guide requires the following prerequisites:
- Infisical account 
- Git installed
- Terraform v1.0 or later installed
- Access to AWS credentials
- Understanding of [Infisical Agent](/)

## What we will deploy

For the purpose of this demonstration, we will deploy [File Browser](https://github.com/filebrowser/filebrowser) to our ECS cluster.
This will enable us to easily confirm that the Infisical agent is indeed depositing the credentials into the specified volume accessible to file browser deployed. 
Of course, in production the volumes where your secrets reside should never be exposed to the public.


## Configure Authentication with Infisical
In order for the Infisical agent to fetch credentials from Infisical, we'll first need to authenticate with Infisical.
While Infisical supports various authentication methods, this guide focuses on using Universal Auth to authenticate the agent with Infisical.

Follow the documentation to configure and generate a client id and client secret with Universal auth [here](/documentation/platform/identities/universal-auth).
Make sure to save these credentials somewhere handy because you'll need them soon.

## Clone guide assets repository
To help you quickly deploy the example application, please clone the guide assets from this [Github repository](https://github.com/Infisical/infisical-guides.git).
This repository contains assets for all Infisical guides. The content for this guide can be within a sub directory called `aws-ecs-with-agent`. 
The guide will assume that `aws-ecs-with-agent` is your working directory going forward.

## Configure AWS credentials
Because we'll be deploying the example application to AWS via Terraform, you will need to obtain a set of `AWS Access Key` and `Secret Key`.
Once you have generated these credentials, export them to your terminal. 

1. Export the AWS Access Key ID:

   ```bash
   export AWS_ACCESS_KEY_ID=<your AWS access key ID>
   ```

2. Export the AWS Secret Access Key:

   ```bash
   export AWS_SECRET_ACCESS_KEY=<your AWS secret access key>
   ```

3. Export the AWS Session Token:

   ```bash
   export AWS_SESSION_TOKEN=<your AWS session token>
   ```

## Deploy example application

Before we can deploy our full application and its related infrastructure with Terraform, we'll need to make a few changes.
Mainly, we'll need to configure our Infisical agent config file.

### Infisical agent configuration 
The agent config file defines what authentication method to use when connecting with Infisical along with where the fetched secrets/access tokens should be saved to.

Since the Infisical agent will be deployed as a sidecar, the agent configuration file and any secret template files need to be encoded in base64. This makes it easier to pass them into Terraform.

#### Secret template file
```secrets.template
{{- with secret "62fd92aa8b63973fee23dec7" "dev" "/" }}
{{- range . }}
{{ .Key }}={{ .Value }}
{{- end }}
{{- end }}
```

Next we need encode this template file in `base64` so that it can be consumed by _____. 

```bash
cat secrets.template | base64 
e3stIHdpdGggc2VjcmV0ICI2MmZkOTJhYThiNjM5NzNmZWUyM2RlYzciICJkZXYiICIvIiB9fQp7ey0gcmFuZ2UgLiB9fQp7eyAuS2V5IH19PXt7IC5WYWx1ZSB9fQp7ey0gZW5kIH19Cnt7LSBlbmQgfX0=
```

#### Agent config file

Finally, we'll define the main agent config. This configuration file 

```yaml agent-config.yaml
infisical:
  address: "https://app.infisical.com"
  exit-after-auth: true
auth:
  type: "universal-auth"
  config:
    remove_client_secret_on_read: false
sinks:
  - type: "file"
    config:
      path: "/infisical-agent/access-token"
templates:
  - base64-template-content: e3stIHdpdGggc2VjcmV0ICI2MmZkOTJhYThiNjM5NzNmZWUyM2RlYzciICJkZXYiICIvIiB9fQp7ey0gcmFuZ2UgLiB9fQp7eyAuS2V5IH19PXt7IC5WYWx1ZSB9fQp7ey0gZW5kIH19Cnt7LSBlbmQgfX0=
    destination-path: /infisical-agent/.env
```



The following resources need to be created:
- AWS ECS Cluster with Fargate as launch type
- EFS volume
- Networking resources 

Instead of creating these resources one by one, we'll use the Terraform template in the guide folder to provision all resources at once.

1. Make sure your current directory is set to `aws-ecs-with-agent`. Once there, change your directory to `terraform`
```sh 
cd terraform
```

2. Initialize Terraform
```
terraform init 
```

3. Preview resources that will be created 
```
terraform plan
```

4. Trigger resource creation
```
terraform apply 
```