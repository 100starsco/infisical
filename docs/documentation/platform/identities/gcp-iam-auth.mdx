---
title: GCP Auth
description: "Learn how to authenticate with Infisical Google Cloud Platform"
---

**GCP IAM Auth** is a GCP-native authentication method for IAM service accounts.

## Concept

At a high-level, Infisical authenticates an IAM service account by verifying its identity and checking that it meets specific requirements (e.g. it is an allowed service account) at the `/api/v1/auth/gcp-iam-auth/login` endpoint. If successful,
then Infisical returns a short-lived access token that can be used to make authenticated requests to the Infisical API.

In GCP IAM Auth, the client generates a signed JWT using the `projects.serviceAccounts.signJwt` [API method](https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/signJwt); this is done using the service account credentials from the GCP environment where the client is running.
The signed JWT is sent to Infisical afterwhich Infisical verifies the JWT and checks if the associated service account is allowed to authenticate with Infisical. If all is well, Infisical returns a short-lived access token that can be used to make authenticated requests to the Infisical API.

<Note>
We recommend using one of Infisical's clients like SDKs or the Infisical Agent
to authenticate with Infisical using GCP IAM Auth as they handle the
authentication process including generating the signed JWT token.

Also, note that Infisical needs network-level access to send requests to the Google Cloud API
as part of the GCP IAM Auth workflow.

</Note>

## Workflow

In the following steps, we explore how to create and use identities for your workloads and applications on GCP to
access the Infisical API using the GCP IAM authentication method.

<Steps>
    <Step title="Creating an identity">
    To create an identity, head to your Organization Settings > Access Control > Machine Identities and press **Create identity**.

    ![identities organization](/images/platform/identities/identities-org.png)

    When creating an identity, you specify an organization level [role](/documentation/platform/role-based-access-controls) for it to assume; you can configure roles in Organization Settings > Access Control > Organization Roles.

    ![identities organization create](/images/platform/identities/identities-org-create.png)

    Now input a few details for your new identity. Here's some guidance for each field:

    - Name (required): A friendly name for the identity.
    - Role (required): A role from the **Organization Roles** tab for the identity to assume. The organization role assigned will determine what organization level resources this identity can have access to.

    Once you've created an identity, you'll be prompted to configure the authentication method for it. Here, select **GCP IAM Auth**.

    ![identities create gcp auth method](/images/platform/identities/identities-org-create-gcp-iam-auth-method.png)

    Here's some more guidance on each field:

    - Allowed Service Account Emails: A comma-separated list of trusted IAM service account emails that are allowed to authenticate with Infisical; this could be something like `test@project.iam.gserviceaccount.com`, `12345-compute@developer.gserviceaccount.com`, etc.
    - Allowed Projects: A comma-separated list of trusted GCP projects that the IAM service accounts must belong to authenticate with Infisical.
    - Access Token TTL (default is `2592000` equivalent to 30 days): The lifetime for an acccess token in seconds. This value will be referenced at renewal time.
    - Access Token Max TTL (default is `2592000`  equivalent to 30 days): The maximum lifetime for an acccess token in seconds. This value will be referenced at renewal time.
    - Access Token Max Number of Uses (default is `0`): The maximum number of times that an access token can be used; a value of `0` implies infinite number of uses.
    - Access Token Trusted IPs: The IPs or CIDR ranges that access tokens can be used from. By default, each token is given the `0.0.0.0/0`, allowing usage from any network address.
    </Step>
    <Step title="Adding an identity to a project">
    To enable the identity to access project-level resources such as secrets within a specific project, you should add it to that project.

    To do this, head over to the project you want to add the identity to and go to Project Settings > Access Control > Machine Identities and press **Add identity**.

    Next, select the identity you want to add to the project and the project level role you want to allow it to assume. The project role assigned will determine what project level resources this identity can have access to.

    ![identities project](/images/platform/identities/identities-project.png)

    ![identities project create](/images/platform/identities/identities-project-create.png)
    </Step>
    <Step title="Accessing the Infisical API with the identity">
        To access the Infisical API as the identity, you need to generate a signed JWT token using the `projects.serviceAccounts.signJwt` [API method](https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/signJwt) and make a request to the `/api/v1/auth/gcp-iam-auth/login` endpoint containing the signed JWT token in exchange for an access token.

        <Info>
            Enable the [IAM Service Account Credentials API](https://console.developers.google.com/apis/api/iamcredentials.googleapis.com/overview) in your project
            Cloud Resource Manager API
            Identity and Access Management (IAM) API has not been used in project 512461120021 before or it is disabled. Enable it by visiting https://console.developers.google.com/apis/api/iam.googleapis.com/overview?project=512461120021 then retry.

            Add the role `roles/iam.serviceAccountTokenCreator` to the service account. This role includes the required `iam.serviceAccounts.signJwt` permission.

            Must have: `resourcemanager.projects.get` (for the Infisical service account)

o Infisical uses scope:https://www.googleapis.com/auth/cloud-platform.read-only

</Info>

        We provide a few code examples below of how you can authenticate with Infisical to access the [Infisical API](/api-reference/overview/introduction).

        <AccordionGroup>
            <Accordion
                title="Sample code for generating a signed JWT token"
            >
                The following query construction provides a generic example of how you can generate a signed JWT token against the `projects.serviceAccounts.signJwt` API method.

                The shown example uses Node.js and the official [google-auth-library](https://github.com/googleapis/google-auth-library-nodejs#readme) package but you can use any language you wish.

                ```javascript
                const { GoogleAuth } = require("google-auth-library");

                const auth = new GoogleAuth({
                    keyFile: serviceAccountKeyFile, // path to the service account JSON key file
                    scopes: "https://www.googleapis.com/auth/cloud-platform",
                });

                const client = await auth.getClient();
                const projectId = await auth.getProjectId();

                const identityId = "<your-infisical-identity-id>";

                const jwtPayload = {
                    sub: client.email,
                    aud: identityId,
                };

                const { data } = await client.request({
                    url: `https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/${client.email}:signJwt`,
                    method: "POST",
                    data: { payload: JSON.stringify(jwtPayload) },
                });

                const jwt = data.signedJwt // send this jwt to Infisical in the next step
                ```

                #### Sample request

                ```bash Request
                curl --location --request POST 'https://app.infisical.com/api/v1/auth/gcp-iam-auth/login' \
                    --header 'Content-Type: application/x-www-form-urlencoded' \
                    --data-urlencode 'identityId=...' \
                    --data-urlencode 'jwt=...'
                ```

                #### Sample response

                ```bash Response
                {
                    "accessToken": "...",
                    "expiresIn": 7200,
                    "accessTokenMaxTTL": 43244
                    "tokenType": "Bearer"
                }
                ```

                Next, you can use the access token to access the [Infisical API](/api-reference/overview/introduction)
            </Accordion>
        </AccordionGroup>

        <Tip>
            We recommend using one of Infisical's clients like SDKs or the Infisical Agent to authenticate with Infisical using GCP IAM Auth as they handle the authentication process including generating the signed JWT token.
        </Tip>
        <Note>
        Each identity access token has a time-to-live (TLL) which you can infer from the response of the login operation;
        the default TTL is `7200` seconds which can be adjusted.
        If an identity access token expires, it can no longer authenticate with the Infisical API. In this case,
        a new access token should be obtained by performing another login operation.
        </Note>
    </Step>

</Steps>
